name: æŒç»­é›†æˆæ£€æŸ¥

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  schedule:
    # æ¯å¤©å‡Œæ™¨2ç‚¹è¿è¡Œä¸€æ¬¡
    - cron: '0 2 * * *'

env:
  NODE_VERSION: '22.17.1'

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥
  code-quality:
    runs-on: ubuntu-latest
    name: ä»£ç è´¨é‡æ£€æŸ¥
    
    strategy:
      matrix:
        node-version: ['18.x', '20.x', '22.x']
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        
    - name: å®‰è£…ä¾èµ–
      run: npm ci
      
    - name: ä»£ç æ ¼å¼æ£€æŸ¥
      run: npm run format:check
      
    - name: ESLintæ£€æŸ¥
      run: npm run lint
      
    - name: TypeScriptç±»å‹æ£€æŸ¥
      run: npm run type-check
      
    - name: æ„å»ºæµ‹è¯•
      run: npm run build
      
    - name: è¿è¡Œæµ‹è¯•
      run: npm test

  # å®‰å…¨æ‰«æ
  security-scan:
    runs-on: ubuntu-latest
    name: å®‰å…¨æ‰«æ
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Node.jsç¯å¢ƒ
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: å®‰è£…ä¾èµ–
      run: npm ci
      
    - name: è¿è¡Œnpm audit
      run: npm audit --audit-level=moderate
      continue-on-error: true
      
    - name: æ£€æŸ¥è¿‡æ—¶ä¾èµ–
      run: npm outdated
      continue-on-error: true

  # æ€§èƒ½æµ‹è¯•
  performance-test:
    runs-on: ubuntu-latest
    name: æ€§èƒ½æµ‹è¯•
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Node.jsç¯å¢ƒ
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: å®‰è£…ä¾èµ–
      run: npm ci
      
    - name: æ„å»ºé¡¹ç›®
      run: npm run build
      
    - name: å¯åŠ¨MCPæœåŠ¡å™¨
      run: |
        node mcp-server.js &
        MCP_PID=$!
        echo "MCP_PID=${MCP_PID}" >> $GITHUB_ENV
        
        # ç­‰å¾…æœåŠ¡å¯åŠ¨
        sleep 10
        
    - name: æ€§èƒ½åŸºå‡†æµ‹è¯•
      run: |
        # æµ‹è¯•æœåŠ¡å™¨å“åº”æ—¶é—´
        echo "æµ‹è¯•MCPæœåŠ¡å™¨å“åº”æ—¶é—´..."
        
        # ä½¿ç”¨curlæµ‹è¯•å“åº”æ—¶é—´
        for i in {1..5}; do
          RESPONSE_TIME=$(curl -o /dev/null -s -w "%{time_total}" http://localhost:3001/api/status || echo "0")
          echo "è¯·æ±‚ $i: ${RESPONSE_TIME}s"
        done
        
        # æµ‹è¯•å†…å­˜ä½¿ç”¨
        echo "æ£€æŸ¥å†…å­˜ä½¿ç”¨æƒ…å†µ..."
        ps -p $MCP_PID -o pid,ppid,cmd,%mem,%cpu --no-headers || echo "è¿›ç¨‹å·²ç»“æŸ"
        
    - name: æ¸…ç†è¿›ç¨‹
      if: always()
      run: |
        if [ ! -z "$MCP_PID" ]; then
          kill $MCP_PID 2>/dev/null || true
        fi
        pkill -f "node mcp-server.js" 2>/dev/null || true

  # å…¼å®¹æ€§æµ‹è¯•
  compatibility-test:
    runs-on: ${{ matrix.os }}
    name: å…¼å®¹æ€§æµ‹è¯•
    
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        node-version: ['18.x', '20.x', '22.x']
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        
    - name: å®‰è£…ä¾èµ–
      run: npm ci
      
    - name: æ„å»ºé¡¹ç›®
      run: npm run build
      
    - name: éªŒè¯æ„å»ºäº§ç‰©
      run: |
        # æ£€æŸ¥å…³é”®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        test -f dist/index.html
        test -f mcp-server.js
        test -f package.json
        
    - name: æµ‹è¯•å¯åŠ¨è„šæœ¬ (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        # æµ‹è¯•Windowså¯åŠ¨è„šæœ¬è¯­æ³•
        if (Test-Path "start-mcp.bat") {
          Write-Host "Windowså¯åŠ¨è„šæœ¬å­˜åœ¨"
        } else {
          Write-Host "è­¦å‘Š: Windowså¯åŠ¨è„šæœ¬ä¸å­˜åœ¨"
        }
      shell: powershell
      
    - name: æµ‹è¯•å¯åŠ¨è„šæœ¬ (Unix)
      if: matrix.os != 'windows-latest'
      run: |
        # æ£€æŸ¥Unixå¯åŠ¨è„šæœ¬
        if [ -f "start-mcp.sh" ]; then
          echo "Unixå¯åŠ¨è„šæœ¬å­˜åœ¨"
          chmod +x start-mcp.sh
        else
          echo "è­¦å‘Š: Unixå¯åŠ¨è„šæœ¬ä¸å­˜åœ¨"
        fi

  # æ–‡æ¡£æ£€æŸ¥
  documentation-check:
    runs-on: ubuntu-latest
    name: æ–‡æ¡£æ£€æŸ¥
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: æ£€æŸ¥å¿…è¦æ–‡æ¡£
      run: |
        echo "æ£€æŸ¥å¿…è¦æ–‡æ¡£æ–‡ä»¶..."
        
        # æ£€æŸ¥READMEæ–‡ä»¶
        if [ -f "README.md" ]; then
          echo "âœ… README.md å­˜åœ¨"
        else
          echo "âŒ README.md ç¼ºå¤±"
          exit 1
        fi
        
        # æ£€æŸ¥å®‰è£…æŒ‡å—
        if [ -f "build/INSTALL.md" ] || [ -f "INSTALL.md" ]; then
          echo "âœ… å®‰è£…æŒ‡å—å­˜åœ¨"
        else
          echo "âš ï¸ å®‰è£…æŒ‡å—ç¼ºå¤±"
        fi
        
        # æ£€æŸ¥éƒ¨ç½²æŒ‡å—
        if [ -f "TraeIDEæ’ä»¶éƒ¨ç½²æŒ‡å—.md" ]; then
          echo "âœ… éƒ¨ç½²æŒ‡å—å­˜åœ¨"
        else
          echo "âš ï¸ éƒ¨ç½²æŒ‡å—ç¼ºå¤±"
        fi
        
        # æ£€æŸ¥äº§å“æ–‡æ¡£
        if [ -f ".trae/documents/TraeIDEé¡¹ç›®åç¦»é¢„é˜²æ’ä»¶äº§å“éœ€æ±‚æ–‡æ¡£.md" ]; then
          echo "âœ… äº§å“éœ€æ±‚æ–‡æ¡£å­˜åœ¨"
        else
          echo "âš ï¸ äº§å“éœ€æ±‚æ–‡æ¡£ç¼ºå¤±"
        fi
        
    - name: æ£€æŸ¥æ–‡æ¡£é“¾æ¥
      run: |
        echo "æ£€æŸ¥READMEä¸­çš„é“¾æ¥..."
        
        # ç®€å•çš„é“¾æ¥æ£€æŸ¥
        if grep -q "http" README.md; then
          echo "å‘ç°å¤–éƒ¨é“¾æ¥ï¼Œå»ºè®®éªŒè¯å¯è®¿é—®æ€§"
        fi
        
        # æ£€æŸ¥ç›¸å¯¹è·¯å¾„é“¾æ¥
        if grep -q "\](.*/" README.md; then
          echo "å‘ç°ç›¸å¯¹è·¯å¾„é“¾æ¥ï¼Œå»ºè®®éªŒè¯æ–‡ä»¶å­˜åœ¨æ€§"
        fi

  # æ„å»ºéªŒè¯
  build-verification:
    runs-on: ubuntu-latest
    name: æ„å»ºéªŒè¯
    needs: [code-quality, security-scan]
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Node.jsç¯å¢ƒ
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: å®‰è£…ä¾èµ–
      run: npm ci
      
    - name: æ¸…ç†æ„å»ºç›®å½•
      run: rm -rf dist build
      
    - name: æ‰§è¡Œå®Œæ•´æ„å»º
      run: npm run build
      
    - name: éªŒè¯æ„å»ºäº§ç‰©
      run: |
        echo "éªŒè¯æ„å»ºäº§ç‰©..."
        
        # æ£€æŸ¥distç›®å½•
        if [ -d "dist" ]; then
          echo "âœ… distç›®å½•å­˜åœ¨"
          echo "distç›®å½•å†…å®¹:"
          ls -la dist/
        else
          echo "âŒ distç›®å½•ä¸å­˜åœ¨"
          exit 1
        fi
        
        # æ£€æŸ¥å…³é”®æ–‡ä»¶
        REQUIRED_FILES=("dist/index.html" "mcp-server.js" "package.json")
        for file in "${REQUIRED_FILES[@]}"; do
          if [ -f "$file" ]; then
            echo "âœ… $file å­˜åœ¨"
          else
            echo "âŒ $file ç¼ºå¤±"
            exit 1
          fi
        done
        
        # æ£€æŸ¥æ–‡ä»¶å¤§å°
        INDEX_SIZE=$(stat -c%s "dist/index.html" 2>/dev/null || echo "0")
        if [ "$INDEX_SIZE" -gt 1000 ]; then
          echo "âœ… index.html å¤§å°æ­£å¸¸ (${INDEX_SIZE} bytes)"
        else
          echo "âš ï¸ index.html å¯èƒ½è¿‡å° (${INDEX_SIZE} bytes)"
        fi
        
    - name: æ¨¡æ‹Ÿæ’ä»¶æ‰“åŒ…
      run: |
        echo "æ¨¡æ‹Ÿæ’ä»¶æ‰“åŒ…è¿‡ç¨‹..."
        
        # åˆ›å»ºä¸´æ—¶æ‰“åŒ…ç›®å½•
        mkdir -p temp-package/traeide-deviation-prevention-plugin
        
        # å¤åˆ¶å¿…è¦æ–‡ä»¶
        cp -r dist temp-package/traeide-deviation-prevention-plugin/
        cp package.json temp-package/traeide-deviation-prevention-plugin/
        cp mcp-server.js temp-package/traeide-deviation-prevention-plugin/
        cp traeide-config.json temp-package/traeide-deviation-prevention-plugin/
        cp README.md temp-package/traeide-deviation-prevention-plugin/
        
        # åˆ›å»ºæ¨¡æ‹Ÿçš„ç¯å¢ƒé…ç½®
        echo "NODE_ENV=production" > temp-package/traeide-deviation-prevention-plugin/.env.production
        
        # æ£€æŸ¥åŒ…å¤§å°
        PACKAGE_SIZE=$(du -sh temp-package/ | cut -f1)
        echo "æ¨¡æ‹ŸåŒ…å¤§å°: ${PACKAGE_SIZE}"
        
        # æ¸…ç†
        rm -rf temp-package
        
    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts-${{ github.sha }}
        path: |
          dist/
          mcp-server.js
          package.json
          traeide-config.json
        retention-days: 7

  # æ€»ç»“æŠ¥å‘Š
  summary:
    runs-on: ubuntu-latest
    name: CIæ€»ç»“æŠ¥å‘Š
    needs: [code-quality, security-scan, performance-test, compatibility-test, documentation-check, build-verification]
    if: always()
    
    steps:
    - name: ç”ŸæˆCIæŠ¥å‘Š
      run: |
        echo "# ğŸ” æŒç»­é›†æˆæ£€æŸ¥æŠ¥å‘Š"
        echo
        echo "## ğŸ“Š æ£€æŸ¥ç»“æœ"
        echo
        echo "| æ£€æŸ¥é¡¹ç›® | çŠ¶æ€ |"
        echo "|----------|------|"
        echo "| ä»£ç è´¨é‡æ£€æŸ¥ | ${{ needs.code-quality.result == 'success' && 'âœ… é€šè¿‡' || 'âŒ å¤±è´¥' }} |"
        echo "| å®‰å…¨æ‰«æ | ${{ needs.security-scan.result == 'success' && 'âœ… é€šè¿‡' || 'âŒ å¤±è´¥' }} |"
        echo "| æ€§èƒ½æµ‹è¯• | ${{ needs.performance-test.result == 'success' && 'âœ… é€šè¿‡' || 'âŒ å¤±è´¥' }} |"
        echo "| å…¼å®¹æ€§æµ‹è¯• | ${{ needs.compatibility-test.result == 'success' && 'âœ… é€šè¿‡' || 'âŒ å¤±è´¥' }} |"
        echo "| æ–‡æ¡£æ£€æŸ¥ | ${{ needs.documentation-check.result == 'success' && 'âœ… é€šè¿‡' || 'âŒ å¤±è´¥' }} |"
        echo "| æ„å»ºéªŒè¯ | ${{ needs.build-verification.result == 'success' && 'âœ… é€šè¿‡' || 'âŒ å¤±è´¥' }} |"
        echo
        echo "## ğŸ“ å»ºè®®"
        
        if [ "${{ needs.code-quality.result }}" != "success" ]; then
          echo "- ğŸ”§ ä¿®å¤ä»£ç è´¨é‡é—®é¢˜"
        fi
        
        if [ "${{ needs.security-scan.result }}" != "success" ]; then
          echo "- ğŸ”’ å¤„ç†å®‰å…¨æ¼æ´"
        fi
        
        if [ "${{ needs.performance-test.result }}" != "success" ]; then
          echo "- âš¡ ä¼˜åŒ–æ€§èƒ½é—®é¢˜"
        fi
        
        if [ "${{ needs.compatibility-test.result }}" != "success" ]; then
          echo "- ğŸ”„ ä¿®å¤å…¼å®¹æ€§é—®é¢˜"
        fi
        
        if [ "${{ needs.documentation-check.result }}" != "success" ]; then
          echo "- ğŸ“š å®Œå–„é¡¹ç›®æ–‡æ¡£"
        fi
        
        if [ "${{ needs.build-verification.result }}" != "success" ]; then
          echo "- ğŸ—ï¸ ä¿®å¤æ„å»ºé—®é¢˜"
        fi
        
        echo
        echo "## ğŸ¯ ä¸‹ä¸€æ­¥"
        echo "- æ ¹æ®ä¸Šè¿°å»ºè®®ä¿®å¤é—®é¢˜"
        echo "- é‡æ–°è¿è¡ŒCIæ£€æŸ¥"
        echo "- å‡†å¤‡å‘å¸ƒç‰ˆæœ¬"
        
    - name: è®¾ç½®CIçŠ¶æ€
      run: |
        if [ "${{ needs.code-quality.result }}" = "success" ] && \
           [ "${{ needs.security-scan.result }}" = "success" ] && \
           [ "${{ needs.build-verification.result }}" = "success" ]; then
          echo "ğŸ‰ CIæ£€æŸ¥å…¨éƒ¨é€šè¿‡ï¼"
          exit 0
        else
          echo "âŒ CIæ£€æŸ¥å­˜åœ¨é—®é¢˜ï¼Œè¯·æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Š"
          exit 1
        fi