name: è‡ªåŠ¨æ›´æ–°ä¾èµ–

on:
  schedule:
    # æ¯å‘¨ä¸€å‡Œæ™¨2ç‚¹è¿è¡Œ
    - cron: '0 2 * * 1'
  workflow_dispatch:
    inputs:
      update_type:
        description: 'æ›´æ–°ç±»å‹'
        required: true
        default: 'patch'
        type: choice
        options:
        - patch
        - minor
        - major
        - all

env:
  NODE_VERSION: '22.17.1'

jobs:
  # æ£€æŸ¥ä¾èµ–æ›´æ–°
  check-updates:
    runs-on: ubuntu-latest
    name: æ£€æŸ¥ä¾èµ–æ›´æ–°
    outputs:
      has-updates: ${{ steps.check.outputs.has-updates }}
      updates-summary: ${{ steps.check.outputs.updates-summary }}
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Node.jsç¯å¢ƒ
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: å®‰è£…ä¾èµ–
      run: npm ci
      
    - name: æ£€æŸ¥è¿‡æ—¶çš„ä¾èµ–
      id: check
      run: |
        echo "æ£€æŸ¥è¿‡æ—¶çš„ä¾èµ–..."
        
        # æ£€æŸ¥è¿‡æ—¶çš„ä¾èµ–
        OUTDATED_OUTPUT=$(npm outdated --json 2>/dev/null || echo '{}')
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ–°
        if [ "$OUTDATED_OUTPUT" = "{}" ]; then
          echo "has-updates=false" >> $GITHUB_OUTPUT
          echo "updates-summary=æ— å¯ç”¨æ›´æ–°" >> $GITHUB_OUTPUT
          echo "âœ… æ‰€æœ‰ä¾èµ–éƒ½æ˜¯æœ€æ–°çš„"
        else
          echo "has-updates=true" >> $GITHUB_OUTPUT
          
          # ç”Ÿæˆæ›´æ–°æ‘˜è¦
          echo "å‘ç°å¯ç”¨æ›´æ–°:"
          echo "$OUTDATED_OUTPUT" | jq -r 'to_entries[] | "- \(.key): \(.value.current) â†’ \(.value.latest)"'
          
          # ä¿å­˜æ‘˜è¦åˆ°è¾“å‡º
          SUMMARY=$(echo "$OUTDATED_OUTPUT" | jq -r 'to_entries[] | "- \(.key): \(.value.current) â†’ \(.value.latest)"' | head -10)
          echo "updates-summary<<EOF" >> $GITHUB_OUTPUT
          echo "$SUMMARY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        fi
        
    - name: å®‰å…¨å®¡è®¡
      run: |
        echo "è¿è¡Œå®‰å…¨å®¡è®¡..."
        npm audit --audit-level=moderate || true
        
    - name: ç”Ÿæˆä¾èµ–æŠ¥å‘Š
      run: |
        echo "# ä¾èµ–æ£€æŸ¥æŠ¥å‘Š" > dependency-report.md
        echo "" >> dependency-report.md
        echo "## ğŸ“Š å½“å‰çŠ¶æ€" >> dependency-report.md
        echo "- æ£€æŸ¥æ—¶é—´: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> dependency-report.md
        echo "- Node.jsç‰ˆæœ¬: ${{ env.NODE_VERSION }}" >> dependency-report.md
        echo "" >> dependency-report.md
        
        if [ "${{ steps.check.outputs.has-updates }}" = "true" ]; then
          echo "## ğŸ”„ å¯ç”¨æ›´æ–°" >> dependency-report.md
          echo "" >> dependency-report.md
          echo "${{ steps.check.outputs.updates-summary }}" >> dependency-report.md
        else
          echo "## âœ… çŠ¶æ€" >> dependency-report.md
          echo "æ‰€æœ‰ä¾èµ–éƒ½æ˜¯æœ€æ–°çš„ï¼" >> dependency-report.md
        fi
        
    - name: ä¸Šä¼ ä¾èµ–æŠ¥å‘Š
      uses: actions/upload-artifact@v4
      with:
        name: dependency-report
        path: dependency-report.md
        retention-days: 30

  # è‡ªåŠ¨æ›´æ–°ä¾èµ–
  update-dependencies:
    runs-on: ubuntu-latest
    name: æ›´æ–°ä¾èµ–
    needs: check-updates
    if: needs.check-updates.outputs.has-updates == 'true'
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: è®¾ç½®Gitç”¨æˆ·
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
    - name: è®¾ç½®Node.jsç¯å¢ƒ
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: å®‰è£…ä¾èµ–
      run: npm ci
      
    - name: æ›´æ–°ä¾èµ–
      run: |
        echo "å¼€å§‹æ›´æ–°ä¾èµ–..."
        
        UPDATE_TYPE="${{ github.event.inputs.update_type || 'patch' }}"
        echo "æ›´æ–°ç±»å‹: $UPDATE_TYPE"
        
        case $UPDATE_TYPE in
          "patch")
            echo "æ›´æ–°è¡¥ä¸ç‰ˆæœ¬..."
            npx npm-check-updates -u --target patch
            ;;
          "minor")
            echo "æ›´æ–°æ¬¡è¦ç‰ˆæœ¬..."
            npx npm-check-updates -u --target minor
            ;;
          "major")
            echo "æ›´æ–°ä¸»è¦ç‰ˆæœ¬..."
            npx npm-check-updates -u --target major
            ;;
          "all")
            echo "æ›´æ–°æ‰€æœ‰ç‰ˆæœ¬..."
            npx npm-check-updates -u
            ;;
          *)
            echo "æœªçŸ¥æ›´æ–°ç±»å‹ï¼Œä½¿ç”¨patch"
            npx npm-check-updates -u --target patch
            ;;
        esac
        
    - name: å®‰è£…æ›´æ–°åçš„ä¾èµ–
      run: |
        echo "å®‰è£…æ›´æ–°åçš„ä¾èµ–..."
        npm install
        
    - name: è¿è¡Œæµ‹è¯•
      run: |
        echo "è¿è¡Œæµ‹è¯•ä»¥éªŒè¯æ›´æ–°..."
        npm test || {
          echo "âŒ æµ‹è¯•å¤±è´¥ï¼Œä¾èµ–æ›´æ–°å¯èƒ½å­˜åœ¨é—®é¢˜"
          exit 1
        }
        
    - name: è¿è¡Œä»£ç æ£€æŸ¥
      run: |
        echo "è¿è¡Œä»£ç è´¨é‡æ£€æŸ¥..."
        npm run lint || {
          echo "âŒ ä»£ç æ£€æŸ¥å¤±è´¥"
          exit 1
        }
        
        npm run type-check || {
          echo "âŒ ç±»å‹æ£€æŸ¥å¤±è´¥"
          exit 1
        }
        
    - name: æ„å»ºé¡¹ç›®
      run: |
        echo "æ„å»ºé¡¹ç›®ä»¥éªŒè¯æ›´æ–°..."
        npm run build || {
          echo "âŒ æ„å»ºå¤±è´¥"
          exit 1
        }
        
    - name: ç”Ÿæˆæ›´æ–°æ‘˜è¦
      run: |
        echo "ç”Ÿæˆæ›´æ–°æ‘˜è¦..."
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
        if git diff --quiet package.json package-lock.json; then
          echo "æ²¡æœ‰ä¾èµ–æ›´æ–°"
          exit 0
        fi
        
        # ç”Ÿæˆå˜æ›´æ‘˜è¦
        cat > update-summary.md << 'EOF'
        # ğŸ”„ ä¾èµ–è‡ªåŠ¨æ›´æ–°
        
        ## ğŸ“‹ æ›´æ–°ä¿¡æ¯
        - **æ›´æ–°æ—¶é—´**: $(date -u +'%Yå¹´%mæœˆ%dæ—¥ %H:%M UTC')
        - **æ›´æ–°ç±»å‹**: ${{ github.event.inputs.update_type || 'patch' }}
        - **è§¦å‘æ–¹å¼**: ${{ github.event_name == 'schedule' && 'å®šæ—¶ä»»åŠ¡' || 'æ‰‹åŠ¨è§¦å‘' }}
        
        ## ğŸ“¦ æ›´æ–°çš„ä¾èµ–
        
        EOF
        
        # æ·»åŠ å…·ä½“çš„å˜æ›´ä¿¡æ¯
        git diff package.json | grep '^[+-]' | grep -v '^[+-][+-][+-]' | sed 's/^+/âœ… æ–°å¢: /' | sed 's/^-/âŒ ç§»é™¤: /' >> update-summary.md
        
        echo "" >> update-summary.md
        echo "## âœ… éªŒè¯ç»“æœ" >> update-summary.md
        echo "- ğŸ§ª æµ‹è¯•é€šè¿‡" >> update-summary.md
        echo "- ğŸ” ä»£ç æ£€æŸ¥é€šè¿‡" >> update-summary.md
        echo "- ğŸ—ï¸ æ„å»ºæˆåŠŸ" >> update-summary.md
        echo "" >> update-summary.md
        echo "## ğŸ”’ å®‰å…¨æ£€æŸ¥" >> update-summary.md
        
        # è¿è¡Œå®‰å…¨å®¡è®¡
        if npm audit --audit-level=moderate; then
          echo "- âœ… æ— å®‰å…¨æ¼æ´" >> update-summary.md
        else
          echo "- âš ï¸ å‘ç°å®‰å…¨é—®é¢˜ï¼Œè¯·æ‰‹åŠ¨æ£€æŸ¥" >> update-summary.md
        fi
        
    - name: åˆ›å»ºPull Request
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: |
          chore(deps): è‡ªåŠ¨æ›´æ–°ä¾èµ– (${{ github.event.inputs.update_type || 'patch' }})
          
          - æ›´æ–°ç±»å‹: ${{ github.event.inputs.update_type || 'patch' }}
          - æ›´æ–°æ—¶é—´: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
          - æ‰€æœ‰æµ‹è¯•é€šè¿‡
          - ä»£ç æ£€æŸ¥é€šè¿‡
          - æ„å»ºæˆåŠŸ
        title: 'ğŸ”„ è‡ªåŠ¨æ›´æ–°ä¾èµ– (${{ github.event.inputs.update_type || 'patch' }})'
        body-path: update-summary.md
        branch: auto-update-dependencies
        delete-branch: true
        labels: |
          dependencies
          automated
        reviewers: |
          # æ·»åŠ é»˜è®¤å®¡æŸ¥è€…
        assignees: |
          # æ·»åŠ é»˜è®¤æŒ‡æ´¾è€…

  # å®‰å…¨æ›´æ–°
  security-update:
    runs-on: ubuntu-latest
    name: å®‰å…¨æ›´æ–°
    if: github.event_name == 'schedule' || github.event.inputs.update_type == 'security'
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: è®¾ç½®Gitç”¨æˆ·
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
    - name: è®¾ç½®Node.jsç¯å¢ƒ
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: å®‰è£…ä¾èµ–
      run: npm ci
      
    - name: è¿è¡Œå®‰å…¨å®¡è®¡
      id: audit
      run: |
        echo "è¿è¡Œå®‰å…¨å®¡è®¡..."
        
        # è¿è¡Œå®¡è®¡å¹¶æ•è·è¾“å‡º
        if npm audit --audit-level=moderate --json > audit-result.json 2>/dev/null; then
          echo "audit-status=clean" >> $GITHUB_OUTPUT
          echo "âœ… æ— å®‰å…¨æ¼æ´"
        else
          echo "audit-status=vulnerabilities" >> $GITHUB_OUTPUT
          echo "âš ï¸ å‘ç°å®‰å…¨æ¼æ´"
          
          # æ˜¾ç¤ºæ¼æ´æ‘˜è¦
          if [ -f audit-result.json ]; then
            jq -r '.vulnerabilities | to_entries[] | "- \(.key): \(.value.severity)"' audit-result.json || true
          fi
        fi
        
    - name: è‡ªåŠ¨ä¿®å¤å®‰å…¨æ¼æ´
      if: steps.audit.outputs.audit-status == 'vulnerabilities'
      run: |
        echo "å°è¯•è‡ªåŠ¨ä¿®å¤å®‰å…¨æ¼æ´..."
        
        # å°è¯•è‡ªåŠ¨ä¿®å¤
        npm audit fix --force || {
          echo "è‡ªåŠ¨ä¿®å¤å¤±è´¥ï¼Œéœ€è¦æ‰‹åŠ¨å¤„ç†"
        }
        
        # é‡æ–°è¿è¡Œå®¡è®¡
        if npm audit --audit-level=moderate; then
          echo "âœ… å®‰å…¨æ¼æ´å·²ä¿®å¤"
        else
          echo "âš ï¸ ä»å­˜åœ¨å®‰å…¨æ¼æ´ï¼Œéœ€è¦æ‰‹åŠ¨å¤„ç†"
        fi
        
    - name: éªŒè¯ä¿®å¤
      if: steps.audit.outputs.audit-status == 'vulnerabilities'
      run: |
        echo "éªŒè¯å®‰å…¨ä¿®å¤..."
        
        # è¿è¡Œæµ‹è¯•
        npm test || {
          echo "âŒ æµ‹è¯•å¤±è´¥ï¼Œå®‰å…¨ä¿®å¤å¯èƒ½ç ´åäº†åŠŸèƒ½"
          git checkout -- package.json package-lock.json
          exit 1
        }
        
        # è¿è¡Œæ„å»º
        npm run build || {
          echo "âŒ æ„å»ºå¤±è´¥ï¼Œå®‰å…¨ä¿®å¤å¯èƒ½ç ´åäº†æ„å»º"
          git checkout -- package.json package-lock.json
          exit 1
        }
        
    - name: åˆ›å»ºå®‰å…¨æ›´æ–°PR
      if: steps.audit.outputs.audit-status == 'vulnerabilities'
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: |
          fix(security): è‡ªåŠ¨ä¿®å¤å®‰å…¨æ¼æ´
          
          - ä¿®å¤æ—¶é—´: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
          - ä¿®å¤æ–¹å¼: npm audit fix
          - æ‰€æœ‰æµ‹è¯•é€šè¿‡
          - æ„å»ºæˆåŠŸ
        title: 'ğŸ”’ å®‰å…¨æ¼æ´è‡ªåŠ¨ä¿®å¤'
        body: |
          # ğŸ”’ å®‰å…¨æ¼æ´è‡ªåŠ¨ä¿®å¤
          
          ## ğŸ“‹ ä¿®å¤ä¿¡æ¯
          - **ä¿®å¤æ—¶é—´**: $(date -u +'%Yå¹´%mæœˆ%dæ—¥ %H:%M UTC')
          - **ä¿®å¤æ–¹å¼**: `npm audit fix`
          - **è§¦å‘åŸå› **: å®šæœŸå®‰å…¨æ£€æŸ¥
          
          ## ğŸ›¡ï¸ å®‰å…¨çŠ¶æ€
          - å·²è¿è¡Œ `npm audit fix` ä¿®å¤å·²çŸ¥æ¼æ´
          - æ‰€æœ‰æµ‹è¯•é€šè¿‡
          - æ„å»ºæˆåŠŸ
          
          ## âš ï¸ æ³¨æ„äº‹é¡¹
          è¯·ä»”ç»†å®¡æŸ¥æ­¤PRï¼Œç¡®ä¿ï¼š
          1. åŠŸèƒ½æ²¡æœ‰è¢«ç ´å
          2. æ‰€æœ‰ä¾èµ–æ›´æ–°éƒ½æ˜¯å¿…è¦çš„
          3. æ²¡æœ‰å¼•å…¥æ–°çš„é—®é¢˜
          
          ## ğŸ” ä¸‹ä¸€æ­¥
          - [ ] ä»£ç å®¡æŸ¥
          - [ ] åŠŸèƒ½æµ‹è¯•
          - [ ] éƒ¨ç½²éªŒè¯
        branch: security-fix-auto
        delete-branch: true
        labels: |
          security
          automated
          high-priority

  # é€šçŸ¥ç»“æœ
  notify:
    runs-on: ubuntu-latest
    name: é€šçŸ¥ç»“æœ
    needs: [check-updates, update-dependencies, security-update]
    if: always()
    
    steps:
    - name: ç”Ÿæˆé€šçŸ¥æ‘˜è¦
      run: |
        echo "# ğŸ“Š ä¾èµ–æ›´æ–°æŠ¥å‘Š" > notification.md
        echo "" >> notification.md
        echo "## ğŸ• æ‰§è¡Œæ—¶é—´" >> notification.md
        echo "$(date -u +'%Yå¹´%mæœˆ%dæ—¥ %H:%M UTC')" >> notification.md
        echo "" >> notification.md
        
        echo "## ğŸ“‹ æ‰§è¡Œç»“æœ" >> notification.md
        echo "| ä»»åŠ¡ | çŠ¶æ€ |" >> notification.md
        echo "|------|------|" >> notification.md
        echo "| æ£€æŸ¥æ›´æ–° | ${{ needs.check-updates.result == 'success' && 'âœ… æˆåŠŸ' || 'âŒ å¤±è´¥' }} |" >> notification.md
        echo "| æ›´æ–°ä¾èµ– | ${{ needs.update-dependencies.result == 'success' && 'âœ… æˆåŠŸ' || needs.update-dependencies.result == 'skipped' && 'â­ï¸ è·³è¿‡' || 'âŒ å¤±è´¥' }} |" >> notification.md
        echo "| å®‰å…¨æ›´æ–° | ${{ needs.security-update.result == 'success' && 'âœ… æˆåŠŸ' || needs.security-update.result == 'skipped' && 'â­ï¸ è·³è¿‡' || 'âŒ å¤±è´¥' }} |" >> notification.md
        echo "" >> notification.md
        
        if [ "${{ needs.check-updates.outputs.has-updates }}" = "true" ]; then
          echo "## ğŸ”„ å‘ç°çš„æ›´æ–°" >> notification.md
          echo "${{ needs.check-updates.outputs.updates-summary }}" >> notification.md
        else
          echo "## âœ… çŠ¶æ€" >> notification.md
          echo "æ‰€æœ‰ä¾èµ–éƒ½æ˜¯æœ€æ–°çš„ï¼" >> notification.md
        fi
        
        echo "" >> notification.md
        echo "## ğŸ”— ç›¸å…³é“¾æ¥" >> notification.md
        echo "- [å·¥ä½œæµè¿è¡Œ](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> notification.md
        echo "- [ä¾èµ–æ£€æŸ¥](https://github.com/${{ github.repository }}/network/dependencies)" >> notification.md
        
        cat notification.md
        
    - name: ä¸Šä¼ é€šçŸ¥æŠ¥å‘Š
      uses: actions/upload-artifact@v4
      with:
        name: dependency-update-notification
        path: notification.md
        retention-days: 30