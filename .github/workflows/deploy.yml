name: è‡ªåŠ¨éƒ¨ç½²TraeIDEæ’ä»¶

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  NODE_VERSION: '22.17.1'
  PLUGIN_NAME: 'traeide-deviation-prevention-plugin'

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥
  quality-check:
    runs-on: ubuntu-latest
    name: ä»£ç è´¨é‡æ£€æŸ¥
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Node.jsçŽ¯å¢ƒ
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: å®‰è£…ä¾èµ–
      run: npm ci
      
    - name: ä»£ç æ ¼å¼æ£€æŸ¥
      run: npm run lint
      
    - name: è¿è¡Œæµ‹è¯•
      run: npm test
      
    - name: ç±»åž‹æ£€æŸ¥
      run: npm run type-check
      continue-on-error: true

  # æž„å»ºå’Œæ‰“åŒ…
  build:
    runs-on: ubuntu-latest
    needs: quality-check
    name: æž„å»ºæ’ä»¶åŒ…
    
    outputs:
      version: ${{ steps.package-info.outputs.version }}
      package-name: ${{ steps.package-info.outputs.package-name }}
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Node.jsçŽ¯å¢ƒ
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: å®‰è£…ä¾èµ–
      run: npm ci
      
    - name: æž„å»ºå‰ç«¯
      run: npm run build
      
    - name: èŽ·å–åŒ…ä¿¡æ¯
      id: package-info
      run: |
        VERSION=$(node -p "require('./package.json').version")
        PACKAGE_NAME="${{ env.PLUGIN_NAME }}-v${VERSION}-production"
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "package-name=${PACKAGE_NAME}" >> $GITHUB_OUTPUT
        echo "Package version: ${VERSION}"
        echo "Package name: ${PACKAGE_NAME}"
        
    - name: åˆ›å»ºç”Ÿäº§çŽ¯å¢ƒé…ç½®
      run: |
        mkdir -p build/${{ env.PLUGIN_NAME }}
        cp -r dist build/${{ env.PLUGIN_NAME }}/
        cp package.json build/${{ env.PLUGIN_NAME }}/
        cp package-lock.json build/${{ env.PLUGIN_NAME }}/
        cp mcp-server.js build/${{ env.PLUGIN_NAME }}/
        cp traeide-config.json build/${{ env.PLUGIN_NAME }}/
        cp README.md build/${{ env.PLUGIN_NAME }}/
        cp -r config build/${{ env.PLUGIN_NAME }}/
        
        # åˆ›å»ºç”Ÿäº§çŽ¯å¢ƒå˜é‡æ–‡ä»¶
        cat > build/${{ env.PLUGIN_NAME }}/.env.production << 'EOF'
        NODE_ENV=production
        MCP_WEB_PORT=3001
        MCP_HOST=localhost
        MCP_PROTOCOL=http
        WEB_PORT=9000
        WEB_HOST=localhost
        DATA_DIR=./data
        LOG_DIR=./logs
        CACHE_DIR=./cache
        MCP_MAX_MEMORY=512
        NODE_MAX_OLD_SPACE_SIZE=512
        CONNECTION_TIMEOUT=30000
        HEALTH_CHECK_INTERVAL=30000
        MAX_CONCURRENT_REQUESTS=10
        MCP_LOG_LEVEL=info
        LOG_MAX_SIZE=10m
        LOG_MAX_FILES=5
        CORS_ENABLED=true
        RATE_LIMIT_ENABLED=true
        DEEPSEEK_API_KEY=
        DEEPSEEK_API_URL=https://api.deepseek.com/v1/chat/completions
        DEEPSEEK_MODEL=deepseek-chat
        DEEPSEEK_MAX_TOKENS=4096
        DEEPSEEK_TEMPERATURE=0.7
        DEEPSEEK_TIMEOUT=30000
        DEVIATION_THRESHOLD=0.8
        AUTO_ANALYZE_ENABLED=true
        SNAPSHOT_ENABLED=true
        CONTEXT_COMPRESSION_ENABLED=true
        DB_PATH=./data/plugin.db
        DB_BACKUP_ENABLED=true
        CACHE_ENABLED=true
        FILE_CACHE_ENABLED=true
        HEALTH_CHECK_ENABLED=true
        PERF_MONITORING_ENABLED=true
        ERROR_TRACKING_ENABLED=true
        EOF
        
        # åˆ›å»ºå¯åŠ¨è„šæœ¬
        cat > build/${{ env.PLUGIN_NAME }}/start-mcp.bat << 'EOF'
        @echo off
        echo å¯åŠ¨TraeIDEé¡¹ç›®åå·®é¢„é˜²æ’ä»¶MCPæœåŠ¡å™¨...
        node mcp-server.js
        EOF
        
        cat > build/${{ env.PLUGIN_NAME }}/stop-mcp.bat << 'EOF'
        @echo off
        echo åœæ­¢TraeIDEé¡¹ç›®åå·®é¢„é˜²æ’ä»¶MCPæœåŠ¡å™¨...
        taskkill /f /im node.exe 2>nul
        echo MCPæœåŠ¡å™¨å·²åœæ­¢
        EOF
        
    - name: åˆ›å»ºæ’ä»¶åŒ…
      run: |
        cd build
        zip -r ${{ steps.package-info.outputs.package-name }}.zip ${{ env.PLUGIN_NAME }}/
        
    - name: ç”Ÿæˆéƒ¨ç½²æŠ¥å‘Š
      run: |
        cat > build/DEPLOYMENT_REPORT.md << EOF
        # TraeIDEé¡¹ç›®åå·®é¢„é˜²æ’ä»¶éƒ¨ç½²æŠ¥å‘Š
        
        ## éƒ¨ç½²ä¿¡æ¯
        - **ç‰ˆæœ¬**: ${{ steps.package-info.outputs.version }}
        - **æž„å»ºæ—¶é—´**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        - **æž„å»ºçŽ¯å¢ƒ**: GitHub Actions (ubuntu-latest)
        - **Node.jsç‰ˆæœ¬**: ${{ env.NODE_VERSION }}
        - **åŒ…åç§°**: ${{ steps.package-info.outputs.package-name }}.zip
        
        ## åŒ…å«æ–‡ä»¶
        - ç”Ÿäº§çŽ¯å¢ƒæ’ä»¶åŒ…
        - MCPæœåŠ¡å™¨æ–‡ä»¶
        - å‰ç«¯æž„å»ºæ–‡ä»¶
        - é…ç½®æ–‡ä»¶
        - å¯åŠ¨è„šæœ¬
        - çŽ¯å¢ƒå˜é‡æ¨¡æ¿
        
        ## å®‰è£…è¯´æ˜Ž
        1. ä¸‹è½½æ’ä»¶åŒ…
        2. è§£åŽ‹åˆ°TraeIDEæ’ä»¶ç›®å½•
        3. é…ç½®.env.productionæ–‡ä»¶
        4. è¿è¡Œstart-mcp.batå¯åŠ¨æœåŠ¡
        
        ## æŠ€æœ¯è§„æ ¼
        - å†…å­˜é™åˆ¶: 512MB
        - ç«¯å£é…ç½®: MCP(3001), Web(9000)
        - æ—¥å¿—çº§åˆ«: info
        - æ”¯æŒè‡ªåŠ¨é‡å¯
        EOF
        
    - name: ä¸Šä¼ æž„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: plugin-package
        path: |
          build/${{ steps.package-info.outputs.package-name }}.zip
          build/DEPLOYMENT_REPORT.md
        retention-days: 30

  # å‘å¸ƒåˆ°GitHub Releases
  release:
    runs-on: ubuntu-latest
    needs: build
    name: å‘å¸ƒåˆ°GitHub
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ä¸‹è½½æž„å»ºäº§ç‰©
      uses: actions/download-artifact@v4
      with:
        name: plugin-package
        path: ./release
        
    - name: åˆ›å»ºå‘å¸ƒè¯´æ˜Ž
      run: |
        cat > release-notes.md << EOF
        # TraeIDEé¡¹ç›®åå·®é¢„é˜²æ’ä»¶ ${{ needs.build.outputs.version }}
        
        ## ðŸš€ æ–°åŠŸèƒ½
        - æ™ºèƒ½é¡¹ç›®åå·®æ£€æµ‹å’Œé¢„é˜²
        - å®žæ—¶ä¸Šä¸‹æ–‡ç®¡ç†
        - éœ€æ±‚è¿½è¸ªå’Œåˆ†æž
        - DeepSeek AIé›†æˆ
        - ä¼šè¯å›žé¡¾å’ŒåŽ†å²ç®¡ç†
        
        ## ðŸ“¦ å®‰è£…æ–¹æ³•
        
        ### æ–¹æ³•1: TraeIDEæ’ä»¶å¸‚åœº
        1. æ‰“å¼€TraeIDE
        2. ç‚¹å‡»æ‰©å±•å›¾æ ‡ (Ctrl+Shift+X)
        3. æœç´¢"é¡¹ç›®åå·®é¢„é˜²"
        4. ç‚¹å‡»å®‰è£…
        
        ### æ–¹æ³•2: æ‰‹åŠ¨å®‰è£…
        1. ä¸‹è½½ \`${{ needs.build.outputs.package-name }}.zip\`
        2. è§£åŽ‹åˆ°TraeIDEæ’ä»¶ç›®å½•
        3. é‡å¯TraeIDE
        4. é…ç½®APIå¯†é’¥
        
        ## ðŸ”§ é…ç½®è¦æ±‚
        - Node.js 18+
        - TraeIDE æœ€æ–°ç‰ˆæœ¬
        - DeepSeek APIå¯†é’¥ï¼ˆå¯é€‰ï¼‰
        
        ## ðŸ“‹ æŠ€æœ¯è§„æ ¼
        - å†…å­˜ä½¿ç”¨: < 512MB
        - å¯åŠ¨æ—¶é—´: < 10ç§’
        - APIå“åº”: < 100ms
        - æ”¯æŒå¹¶å‘: 10ä¸ªè¯·æ±‚
        
        ## ðŸ› é—®é¢˜åé¦ˆ
        å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·åœ¨GitHub Issuesä¸­åé¦ˆã€‚
        EOF
        
    - name: åˆ›å»ºGitHub Release
      uses: softprops/action-gh-release@v1
      with:
        name: TraeIDEé¡¹ç›®åå·®é¢„é˜²æ’ä»¶ ${{ needs.build.outputs.version }}
        body_path: release-notes.md
        files: |
          release/${{ needs.build.outputs.package-name }}.zip
          release/DEPLOYMENT_REPORT.md
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # éƒ¨ç½²çŠ¶æ€é€šçŸ¥
  notify:
    runs-on: ubuntu-latest
    needs: [quality-check, build, release]
    name: éƒ¨ç½²çŠ¶æ€é€šçŸ¥
    if: always()
    
    steps:
    - name: éƒ¨ç½²æˆåŠŸé€šçŸ¥
      if: needs.build.result == 'success'
      run: |
        echo "âœ… éƒ¨ç½²æˆåŠŸï¼"
        echo "ç‰ˆæœ¬: ${{ needs.build.outputs.version }}"
        echo "åŒ…å: ${{ needs.build.outputs.package-name }}.zip"
        
    - name: éƒ¨ç½²å¤±è´¥é€šçŸ¥
      if: needs.build.result == 'failure'
      run: |
        echo "âŒ éƒ¨ç½²å¤±è´¥ï¼"
        echo "è¯·æ£€æŸ¥æž„å»ºæ—¥å¿—èŽ·å–è¯¦ç»†ä¿¡æ¯"
        exit 1